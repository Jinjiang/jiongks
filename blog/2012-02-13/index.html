<!DOCTYPE html>
<html>

<head>
  <!-- proud for contributing Vue.js -->
  <meta charset="utf-8">
  <meta name="format-detection" content="telephone=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes" />

  
  <title>
    
    IndexedDBæŠ€æœ¯ç®€ä»‹(ä¸‰) -
    
    å›§å…‹æ–¯
  </title>

  
<link rel="stylesheet" href="/css/pure.css">

  
<link rel="stylesheet" href="/css/style.css">


  
  <link rel="alternate" href="/atom.xml" title="å›§å…‹æ–¯" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.ico">
  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <script>(() => { if ((new Date().getHours() + 6) % 24 < 12) document.body.classList.add('dark-mode') })()</script>

  <div class="dark-mode-helper"></div>

  <div id="wrapper">

    <div id="header">
      <h1>
        <a href="/" title="å›§å…‹æ–¯">
          å›§å…‹æ–¯
        </a>
      </h1>
      <p class="description">
        è¿™é‡Œæ˜¯å‹¾ä¸‰è‚¡å››çš„å®¶
      </p>
    </div>

    <div id="nav" class="pure-menu pure-menu-open pure-menu-horizontal">
      <ul>
        
        <li>
          <a href="/all-demos/">
            çº¿ä¸Š
          </a>
        </li>
        
        <li>
          <a href="/all-slides/">
            çº¿ä¸‹
          </a>
        </li>
        
        <li>
          <a href="/about/">
            å…³äº
          </a>
        </li>
        
        <li><a href="/archives">å½’æ¡£</li>
      </ul>
    </div>

    <div id="main"><div class="content">
  <h2>
    IndexedDBæŠ€æœ¯ç®€ä»‹(ä¸‰)
  </h2>
  
<p><mark>æœ¬æ–‡æ‘˜è‡ª å‹¾ä¸‰è‚¡å›› æ›´æ—©æ—¶æœŸçš„ <a target="_blank" rel="noopener" href="http://bulaoge.net/?g3g4">ä¸è€æ­Œ</a> åšå®¢ã€‚</mark></p>

<a id="more"></a>
<p>ä»Šå¤©åšä¸€ä¸ªIndexedDB(ä»¥ä¸‹ç®€ç§°IDB)çš„demoï¼Œè¿è¡Œç¯å¢ƒæ˜¯Firefox 10ã€‚<br>
<br>
<a href="http://jinjiang.github.com/demos/indexed-db/firefox-10.html" target="_blank">DEMOæ¼”ç¤ºé“¾æ¥</a> (firefox 10+ only)<br>
<br>
æˆ‘ä»¬åšä¸€ä¸ªé˜…è¯»åˆ—è¡¨çš„é¡µé¢ï¼Œå¯ä»¥è®©ç”¨æˆ·æŠŠä»»æ„ç½‘å€å­˜å…¥è¿™ä¸ªé˜…è¯»åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªç½‘å€èµ·ä¸€ä¸ªåå­—ï¼Œä¹Ÿå¯ä»¥éšæ—¶åˆ é™¤ï¼Œä¸”åˆ—è¡¨å¯ä»¥æŒ‰ç½‘å€è‡ªåŠ¨å»é‡ã€‚<br>
<br>
æ­£å¦‚ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å…ˆåˆå§‹åŒ–æ•°æ®åº“ï¼Œç„¶åå»ºè¡¨ï¼Œç„¶åæŠŠæ·»åŠ /åˆ é™¤/è¯»å–ç½‘å€çš„äº‹ä»¶å’Œæ•°æ®åº“æ“ä½œç»‘å®šåœ¨ä¸€èµ·ã€‚<br>
<br>
é¦–å…ˆæ˜¯htmlä»£ç ï¼š
<pre>_body onload="<strong>init()</strong>">
    _button onclick="<strong>clickAddBtn()</strong>">Add_/button>
    _ul <strong>id="list"</strong>>_/ul>
_/body></pre>
ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å¼•å…¥jQueryä½œç•Œé¢å¤„ç†ï¼Œå†å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡<code>db</code>ï¼Œä½œä¸ºæ•°æ®åº“è¿æ¥çš„å¥æŸ„ï¼›å†å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡<code>list</code>ï¼Œä½œä¸ºç½‘é¡µä¸­åˆ—è¡¨å…ƒç´ çš„jQueryå¥æŸ„ã€‚
<pre>var db;
var list = $('#list');</pre>
ç„¶åå®šä¹‰æ•°æ®åº“åˆå§‹åŒ–çš„è¡Œæ•°<code>init</code>
<pre>function init() {
    var req = window.<strong>mozIndexedDB</strong>.open('readinglist', '1.0');
    req.onsuccess = function (e) {
        <strong>db = this.result;</strong>
        // TODO: è¿æ¥æˆåŠŸåå±•ç¤ºåˆ—è¡¨
    };
    req.onupgradeneeded = function (e) {
        <strong>db = this.result;</strong>
        // TODO: ç‰ˆæœ¬ä¸åŒæ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„object store
    };
}</pre>
è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯åˆå§‹åŒ–æ•°æ®åº“(<code>readinglist</code>)è¿æ¥ï¼Œå¹¶åœ¨ç¬¬ä¸€æ¬¡è¿æ¥æ•°æ®åº“æ—¶åˆ›å»ºè¡¨(<code>links</code>)ã€‚æˆ‘ä»¬æŠŠå±•ç¤ºåˆ—è¡¨çš„å‡½æ•°å®šä¹‰ä¸º<code>showList()</code>ï¼ŒæŠŠåˆ›å»ºè¡¨çš„ä»£ç ä¹Ÿè¡¥å……å®Œæ•´ï¼Œå³ï¼š
<pre>function init() {
    var req = window.mozIndexedDB.open('readinglist', '1.0');
    req.onsuccess = function (e) {
        db = this.result;
        <strong>showList();</strong>
    };
    req.onupgradeneeded = function (e) {
        db = this.result;
        <strong>db.createObjectStore('links', {keyPath: 'url'});</strong>
    };
}</pre>
ç„¶åæˆ‘ä»¬å®šä¹‰æ·»åŠ /åˆ é™¤/å±•ç¤ºé“¾æ¥çš„å‡½æ•°ï¼š<code>add(title, url)</code>/<code>remove(url)</code>/<code>showList()</code>
<pre>function add(<strong>title, url</strong>) {
    var <strong>link</strong> = {
        title: title,
        url: url
    }; // åˆ›å»ºè¦å­˜å‚¨çš„å¯¹è±¡
    var transaction = db.transaction('links', IDBTransaction.READ_WRITE);
    var store = transaction.objectStore('links');
    <strong>var req = store.put(link);</strong> // putçš„ä½œç”¨æ˜¯keyå­˜åœ¨æ—¶åšæ›´æ–°å¤„ç†ï¼Œä¸å­˜åœ¨æ˜¯åšæ·»åŠ å¤„ç†
    <strong>req.onsuccess = showList;</strong> // æ·»åŠ æˆåŠŸåé‡æ–°å±•ç¤ºåˆ—è¡¨
}

function remove(<strong>url</strong>) {
    var transaction = db.transaction('links', IDBTransaction.READ_WRITE);
    var store = transaction.objectStore('links');
    <strong>var req = store.delete(url);</strong> // åˆ é™¤æ­¤é“¾æ¥
    <strong>req.onsuccess = showList;</strong> // åˆ é™¤æˆåŠŸåé‡æ–°å±•ç¤ºåˆ—è¡¨
}

function showList() {
    // TODO: clear element: #list

    var transaction = db.transaction('links');
    var store = transaction.objectStore('links');
    <strong>var range = IDBKeyRange.lowerBound(0);</strong> // åˆ›å»ºå…³é”®å­—èŒƒå›´æè¿°
    <strong>var req = store.openCursor(range);</strong> // åˆ›å»ºåœ¨ä¸Šè¿°èŒƒå›´å†…éå†çš„æ¸¸æ ‡
    req.onsuccess = function (e) {
        var result = this.result;
        if (result) {
            var link = result.value;
            // TODO: append this link to element: #list
            <strong>result.continue();</strong>
        }
    };
}</pre>
æ³¨æ„è¿™é‡Œçš„<code><a href="http://www.w3.org/TR/IndexedDB/#idl-def-IDBKeyRange" target="_blank">IDBKeyRange</a></code>å’Œ<code>store.openCursor</code>æ˜¯ç”¨æ¥éå†åˆ—è¡¨çš„ï¼Œå‰è€…ç¡®å®šéå†çš„èŒƒå›´ï¼Œåè€…æ ¹æ®å‰è€…çš„èŒƒå›´é€æ¡è§¦å‘<code>onsuccess</code>äº‹ä»¶ï¼Œè¿™é‡Œå®šä¹‰çš„éå†èŒƒå›´æ˜¯å¤§äº0ï¼Œå³æ‰€æœ‰éç©ºçš„urlï¼Œå…¶å®æ‰€æœ‰jsç±»å‹çš„å€¼éƒ½æ˜¯å¯ä»¥åœ¨ä¸€èµ·æ¯”å¤§å°çš„ï¼Œå¦‚æœæƒ³æµ‹è¯•<a href="http://www.w3.org/TR/IndexedDB/#key-construct" target="_blank">æ¯”è¾ƒä»»æ„ä¸¤ä¸ªkeyçš„å¤§å°</a>ï¼Œå¯ä»¥è¿è¡Œå‡½æ•°<code>window.mozIndexedDB.cmp(any first, any second)</code>ã€‚<br>
<br>
æœ€åï¼Œæˆ‘ä»¬æŠŠæœ€åä¸¤ä¸ª<code>TODO</code>çš„éƒ¨åˆ†è¡¥å……å®Œæ•´ï¼Œå†æŠŠç•Œé¢ä¸Šçš„äº‹ä»¶ç»‘å®šå¥½ã€‚ç¼–ç å·¥ä½œå°±å®Œæˆäº†ã€‚

<pre>function showList() {
    <strong>list.empty();</strong>

    var transaction = db.transaction('links');
    var store = transaction.objectStore('links');
    var range = IDBKeyRange.lowerBound(0); // åˆ›å»ºå…³é”®å­—èŒƒå›´æè¿°
    var req = store.openCursor(range); // åˆ›å»ºåœ¨ä¸Šè¿°èŒƒå›´å†…éå†çš„æ¸¸æ ‡
    req.onsuccess = function (e) {
        var result = this.result;
        if (result) {
            var link = result.value;
            <strong>appendLink(link);</strong>
            result.continue();
        }
    };
}

function appendLink(link) {
    var url = link.url;
    var title = link.title;
    var li = $('_li>_a href="#" target="_blank">_/a> _button>X_/button>_/li>');
    li.find('a').attr('title', title).attr('href', url).text(title);
    li.find('button').click(function (e) {
        <strong>remove(link.url);</strong>
    });
    list.append(li);
}

function clickAddBtn(e) {
    var title = prompt('please input the title') || '[No title]';
    var url = prompt('please input the url', 'http://');
    if (title && url) {
        <strong>add(title, url);</strong>
    }
}</pre>
<br>
<a href="http://jinjiang.github.com/demos/indexed-db/firefox-10.html" target="_blank">DEMOæ¼”ç¤ºé“¾æ¥</a> (firefox 10+ only)<br>
<br>
ä¸‹ä¸€ç¯‡è®¨è®ºwebkitä¸‹ä½¿ç”¨IDBçš„æ³¨æ„äº‹é¡¹ï¼Œå¹¶æä¾›å…¼å®¹é—®é¢˜çš„è§£å†³åŠæ³•ã€‚<br>
<br>
(æœªå®Œå¾…ç»­)</p>

</div>

<p align="right">
  <small>
    <a href="https://github.com/Jinjiang/jinjiang.github.io/edit/dev/source/_posts/2012-02-13.md" target="_blank">
      å‘æœ¬æ–‡æå‡ºä¿®æ”¹æˆ–å‹˜è¯¯å»ºè®®
    </a>
  </small>
</p>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>
  const gitalk = new Gitalk({
    clientID: 'c99e23053fc1bba6a58c',
    clientSecret: '64efe1cd1438e77ae2bf8eba92b51c90d0cc2b9f',
    repo: 'jinjiang.github.io',
    owner: 'jinjiang',
    admin: ['jinjiang'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')
</script>
</div>

    <div id="footer">
      <a href="/">å›§å…‹æ–¯</a>
      
      |
      <a href="/atom.xml" title="rss_feed">RSS</a>
      
      |
      æˆ‘æ˜¯ç™¾åº¦ç»Ÿè®¡
      <script src="https://hm.baidu.com/h.js?a0a2372d4b7621d0bfe71f33c58a4bd8"></script>
      |
      æˆ‘ä¼šç¿»è„¸ <a href="#" onclick="document.body.classList.toggle('dark-mode'), event.preventDefault()" style="font-size: 1.25em;">ğŸŒšğŸŒ</a>
    </div>
  </div>

  
<script src="/js/script.js"></script>

</body>

</html>
